name: PSX Market Scraper (Production)

on:
  schedule:
    # Trigger frequently; actual control happens inside job
    - cron: "*/5 4-11 * * 1-5"
  workflow_dispatch:

concurrency:
  group: psx-scraper
  cancel-in-progress: true

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------- STRICT MARKET TIME GUARD --------
      - name: Market time guard (PKT aware)
        run: |
          DAY=$(date -u +"%u")      # 1=Mon ... 7=Sun
          HOUR=$(date -u +"%H")
          MIN=$(date -u +"%M")
          TIME=$((10#$HOUR * 60 + 10#$MIN))

          echo "UTC Day=$DAY | Time=${HOUR}:${MIN}"

          # Mon–Thu: 04:30–10:30 UTC
          if [ "$DAY" -ge 1 ] && [ "$DAY" -le 4 ]; then
            START=$((4 * 60 + 30))
            END=$((10 * 60 + 30))

            if [ "$TIME" -lt "$START" ] || [ "$TIME" -gt "$END" ]; then
              echo "Outside Mon–Thu market hours. Exit."
              exit 0
            fi
          fi

          # Friday: allow only two windows (±2 min tolerance)
          if [ "$DAY" -eq 5 ]; then
            T1=$((4 * 60 + 30))
            T2=$((9 * 60 + 30))

            DIFF1=$((TIME > T1 ? TIME - T1 : T1 - TIME))
            DIFF2=$((TIME > T2 ? TIME - T2 : T2 - TIME))

            if [ "$DIFF1" -gt 2 ] && [ "$DIFF2" -gt 2 ]; then
              echo "Friday: not allowed run window. Exit."
              exit 0
            fi
          fi

          echo "Market window valid."

      # -------- RUN SCRAPER --------
      - name: Run PSX scraper
        run: |
          python deepsupabasecode.py
